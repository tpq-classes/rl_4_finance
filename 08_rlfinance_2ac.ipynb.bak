{
 "cells": [
  {
   "cell_type": "markdown",
   "id": "475819a4-e148-4616-b1cb-44b659aeb08a",
   "metadata": {},
   "source": [
    "<img src=\"http://hilpisch.com/tpq_logo.png\" alt=\"The Python Quants\" width=\"35%\" align=\"right\" border=\"0\"><br>"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "280cc0c6-2c18-46cd-8af7-3f19b64a6d7e",
   "metadata": {},
   "source": [
    "# Reinforcement Learning for Finance\n",
    "\n",
    "**Chapter 08 &mdash; Asset Allocation**\n",
    "\n",
    "&copy; Dr. Yves J. Hilpisch\n",
    "\n",
    "<a href=\"http://tpq.io\" target=\"_blank\">http://tpq.io</a> | <a href=\"http://twitter.com/dyjh\" target=\"_blank\">@dyjh</a> | <a href=\"mailto:team@tpq.io\">team@tpq.io</a>"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "8110b8f2-4717-4417-8af8-25e1d8241d28",
   "metadata": {},
   "source": [
    "### Please use the \"Python 3.10, Tensorflow 2.10\" kernel."
   ]
  },
  {
   "cell_type": "markdown",
   "id": "adcfb8e0-6497-4d2e-a261-6762373fd693",
   "metadata": {},
   "source": [
    "## Capital Market Line"
   ]
  },
  {
   "cell_type": "code",
   "metadata": {},
   "execution_count": null,
   "outputs": [],
   "source": [
    "!git clone https://github.com/tpq-classes/rl_4_finance.git\n",
    "import sys\n",
    "sys.path.append('rl_4_finance')\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "b74284e7-9506-4793-bc99-016775313b22",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "import math\n",
    "import random\n",
    "import numpy as np\n",
    "import pandas as pd\n",
    "from scipy import stats\n",
    "from pylab import plt, mpl"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "e80ce705-6c55-46d9-9199-549d8ea689f8",
   "metadata": {},
   "outputs": [],
   "source": [
    "plt.style.use('seaborn-v0_8')\n",
    "mpl.rcParams['font.family'] = 'serif'\n",
    "np.set_printoptions(suppress=True)\n",
    "pd.set_option('display.float_format', lambda x: '%.3f' % x)\n",
    "%config InlineBackend.figure_format = 'svg'"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "ee1c1641-9894-48dd-90f0-215c1d276c17",
   "metadata": {},
   "outputs": [],
   "source": [
    "r = 0.025  # <1>\n",
    "beta = 0.2  # <2>\n",
    "sigma = 0.375  # <3>\n",
    "mu = r + beta * sigma  # <4>\n",
    "mu  # <4>"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "7785eae1-d7cb-4ebd-a9b2-67f73703b667",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "vol = np.linspace(0, 0.5)  # <5>\n",
    "ret = r + beta * vol  # <5>"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "bdf3e816-6483-4694-8566-495bd7154511",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "fig, ax = plt.subplots()\n",
    "plt.plot(vol, ret, 'b', label='capital market line (CML)')\n",
    "plt.plot(0, r, 'g^', label='riskless asset')\n",
    "plt.plot(sigma, mu, 'ro', label='market portfolio')\n",
    "plt.xlabel('volatility/risk')\n",
    "plt.ylabel('expected return')\n",
    "ax.set_xticks((0, sigma))\n",
    "ax.set_xticklabels((0, '$\\sigma$',))\n",
    "ax.set_yticks((0, r, mu))\n",
    "ax.set_yticklabels((0, '$r$', '$\\mu$'))\n",
    "plt.ylim(0, 0.15)\n",
    "plt.legend();"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "36861754-df58-40cf-a690-512291df5731",
   "metadata": {},
   "source": [
    "## Investing Environment"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "0585829d-c4a2-494f-a5b9-ba3a0c6d5b1c",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "class observation_space:\n",
    "    def __init__(self, n):\n",
    "        self.shape = (n,)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "754cfe0d-8fff-4d2d-b96a-d6c611de6226",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "class action_space:\n",
    "    def __init__(self, n):\n",
    "        self.n = n\n",
    "        \n",
    "    def seed(self, seed):\n",
    "        random.seed(seed)\n",
    "        \n",
    "    def sample(self):\n",
    "        return random.random()  # <1>"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "622556ea-c7fc-4418-862e-c0403506f175",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "class Investing:\n",
    "    def __init__(self, S0, T, r_, mu_, sigma_, steps, amount):\n",
    "        self.initial_value = S0\n",
    "        self.maturity = T\n",
    "        self.short_rate_ = r_  # <1>\n",
    "        self.index_drift_ = mu_  # <1>\n",
    "        self.volatility_ = sigma_  # <1>\n",
    "        self.steps = steps\n",
    "        self.initial_balance = amount  # <2>\n",
    "        self.portfolio_value = amount  # <3>\n",
    "        self.portfolio_value_new = amount  # <4>\n",
    "        self.observation_space = observation_space(4)\n",
    "        self.osn = self.observation_space.shape[0]\n",
    "        self.action_space = action_space(1)\n",
    "        self._generate_data()\n",
    "        self.portfolios = pd.DataFrame()\n",
    "        self.episode = 0"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "bae8dc41-21a9-46e6-abc4-5b18a83a2839",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "class Investing(Investing):\n",
    "    def _generate_data(self):\n",
    "        s = [self.initial_value]\n",
    "        self.short_rate = random.choice(self.short_rate_)  # <1>\n",
    "        self.index_drift = random.choice(self.index_drift_)  # <1>\n",
    "        self.volatility = random.choice(self.volatility_)  # <1>\n",
    "        self.dt = self.maturity / self.steps\n",
    "        for t in range(1, self.steps + 1):\n",
    "            st = s[t - 1] * math.exp(\n",
    "                (self.index_drift * self.dt +\n",
    "                  self.volatility * math.sqrt(self.dt) * random.gauss(0, 1))\n",
    "            )  # <2>\n",
    "            s.append(st)\n",
    "        self.data = pd.DataFrame(s, columns=['Xt'])\n",
    "        self.data['Yt'] = self.initial_value * np.exp(\n",
    "            self.short_rate * np.arange(len(self.data)) * self.dt)  # <3>"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "303c0a10-95af-42e1-8f97-0c9ecc91d4d7",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "class Investing(Investing):\n",
    "    def _get_state(self):\n",
    "        Xt = self.data['Xt'].iloc[self.bar]\n",
    "        Yt = self.data['Yt'].iloc[self.bar]\n",
    "        return np.array([Xt, Yt, self.xt, self.yt]), {}\n",
    "        \n",
    "    def seed(self, seed=None):\n",
    "        if seed is not None:\n",
    "            random.seed(seed)\n",
    "            \n",
    "    def reset(self):\n",
    "        self.bar = 0\n",
    "        self.yt = 0\n",
    "        self.xt = 0\n",
    "        self.treward = 0\n",
    "        self.portfolio_value = self.initial_balance\n",
    "        self.portfolio_value_new = self.initial_balance\n",
    "        self.episode += 1\n",
    "        self._generate_data()\n",
    "        self.state, _ = self._get_state()\n",
    "        return self.state, _"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "4ceb2abe-a786-4fcf-a570-24e7099cfae8",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "class Investing(Investing):\n",
    "    def add_results(self, pl):\n",
    "        df = pd.DataFrame({'e': self.episode, 'xt': self.xt,\n",
    "                   'yt': self.yt, 'pv': self.portfolio_value,\n",
    "                   'pv_new': self.portfolio_value_new, 'p&l[$]': pl, \n",
    "                   'p&l[%]': pl / self.portfolio_value_new,\n",
    "                   'Xt': self.state[0],  'Yt': self.state[1],\n",
    "                   'Xt_new': self.new_state[0],\n",
    "                   'Yt_new': self.new_state[1],\n",
    "                   'r': self.short_rate, 'mu': self.index_drift,\n",
    "                   'sigma': self.volatility}, index=[0])\n",
    "        self.portfolios = pd.concat((self.portfolios, df),\n",
    "                                    ignore_index=True)\n",
    "        \n",
    "    def step(self, action):\n",
    "        self.bar += 1\n",
    "        self.new_state, _ = self._get_state()\n",
    "        if self.bar == 1:  # <1>\n",
    "            self.xt = action # <2>\n",
    "            self.yt = (1 - action) # <3>\n",
    "            pl = 0.\n",
    "            reward = 0.\n",
    "            self.add_results(pl)\n",
    "        else:\n",
    "            self.portfolio_value_new = (\n",
    "                self.xt * self.portfolio_value *\n",
    "                self.new_state[0] / self.state[0] +\n",
    "                self.yt * self.portfolio_value *\n",
    "                self.new_state[1] / self.state[1])  # <4>\n",
    "            pl = self.portfolio_value_new - self.portfolio_value  # <5>\n",
    "            self.xt = action # <6>\n",
    "            self.yt = (1 - action) # <7>\n",
    "            self.add_results(pl)  # <8>\n",
    "            reward = pl  # <9>\n",
    "            self.portfolio_value = self.portfolio_value_new  # <10>\n",
    "        if self.bar == len(self.data) - 1:\n",
    "            done = True\n",
    "        else:\n",
    "            done = False\n",
    "        self.state = self.new_state\n",
    "        return self.state, reward, done, False, {}"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "35fc17a3-cdac-4fff-960b-b2a5e900bb2e",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "S0 = 1."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "31dfa81a-3ff7-4d93-ad75-d60326a300eb",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "investing = Investing(S0=S0, T=1.0, r_=[0.05], mu_=[0.3],\n",
    "              sigma_=[0.35], steps=252, amount=1)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "130fa362-6876-4749-88fa-077160c3de51",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "investing.seed(750)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "eceaf5ef-48f2-437f-99a6-1e8fcadbef6a",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "investing._generate_data()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "da77a7be-7ebc-4f00-8aa8-e07d4029a7a5",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "investing.data.plot(style=['g--', 'b:'], lw=1.0);"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "3686b411-5f39-487c-91bb-bc794320e590",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "investing.reset()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "e3325e79-9775-45e5-9796-cea322034eea",
   "metadata": {
    "scrolled": true,
    "tags": []
   },
   "outputs": [],
   "source": [
    "for _ in range(investing.steps - 1):\n",
    "    investing.step(investing.action_space.sample())  # random agent"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "e2cf19e9-f371-44f6-9a1e-ccbc126f44f7",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "investing.portfolios.head().round(3)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "24ef9a67-2628-4d0e-a911-57702ba9a239",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "investing.portfolios[['Xt', 'Yt', 'pv']].plot(\n",
    "    title='PORTFOLIO VALUE | RANDOM AGENT',\n",
    "    style=['g--', 'b:', 'r-'], lw=1);"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "532b56e1-1b75-4e57-8e99-21c3a51a25d4",
   "metadata": {},
   "outputs": [],
   "source": [
    "import os\n",
    "import warnings\n",
    "warnings.simplefilter('ignore')\n",
    "os.environ['TF_CPP_MIN_LOG_LEVEL'] = '3'"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "81052058-331d-41af-99f6-803514a933fc",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "from dqlagent import *"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "493701f2-b72d-45f0-87da-f2f1fb98130b",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "opt = keras.optimizers.legacy.Adam"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "1bd8fb5d-39f5-4e83-9118-c78846e545a0",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "class InvestingAgent(DQLAgent):\n",
    "    def _create_model(self, hu, lr):\n",
    "        self.model = Sequential()\n",
    "        self.model.add(Dense(hu, input_dim=self.n_features,\n",
    "                        activation='relu'))\n",
    "        self.model.add(Dense(hu, activation='relu'))\n",
    "        self.model.add(Dense(1, activation='linear'))  # <1>\n",
    "        self.model.compile(loss='mse',\n",
    "                optimizer=opt(learning_rate=lr))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "47f55cb0-9513-4a20-aad6-7cba3fc0be7a",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "from scipy.optimize import minimize"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "6085e91b-cc2e-4c99-8d05-205892fb0272",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "class InvestingAgent(InvestingAgent):\n",
    "    def opt_action(self, state):\n",
    "        bnds = [(0, 1)]  # <1>\n",
    "        def f(state, x):  # <2>\n",
    "            s = state.copy()\n",
    "            s[0, 2] = x  # <3>\n",
    "            s[0, 3] = 1 - x  # <4>\n",
    "            return self.model.predict(s)[0, 0]  # <5>\n",
    "        action = minimize(lambda x: -f(state, x), 0.5,\n",
    "                          bounds=bnds, method='Powell')['x'][0]  # <6>\n",
    "        return action\n",
    "        \n",
    "    def act(self, state):\n",
    "        if random.random() <= self.epsilon:\n",
    "            return self.env.action_space.sample()\n",
    "        action = self.opt_action(state)  # <7>\n",
    "        return action"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "f14d3677-9499-4c71-973e-3b9008028dcc",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "class InvestingAgent(InvestingAgent):\n",
    "    def replay(self):\n",
    "        batch = random.sample(self.memory, self.batch_size)\n",
    "        for state, action, next_state, reward, done in batch:\n",
    "            if not done:\n",
    "                action = self.opt_action(next_state)  # <1>\n",
    "                next_state[0, 2] = action  # <2>\n",
    "                next_state[0, 3] = 1 - action  # <3>\n",
    "                reward += (self.gamma *\n",
    "                    self.model.predict(next_state)[0, 0])  # <4>\n",
    "            reward = np.array([reward])\n",
    "            self.model.fit(state, reward, epochs=1,\n",
    "                           verbose=False)\n",
    "        if self.epsilon > self.epsilon_min:\n",
    "            self.epsilon *= self.epsilon_decay"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "e5c90b10-fa10-41c4-ad62-555ea76b7c63",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "class InvestingAgent(InvestingAgent):\n",
    "    def test(self, episodes, verbose=True):\n",
    "        for e in range(1, episodes + 1):\n",
    "            state, _ = self.env.reset()\n",
    "            state = self._reshape(state)\n",
    "            treward = 0\n",
    "            for _ in range(1, len(self.env.data) + 1):\n",
    "                action = self.opt_action(state)\n",
    "                state, reward, done, trunc, _ = self.env.step(action)\n",
    "                state = self._reshape(state)\n",
    "                treward += reward\n",
    "                if done:\n",
    "                    templ = f'episode={e} | '\n",
    "                    templ += f'total reward={treward:4.2f}'\n",
    "                    if verbose:\n",
    "                        print(templ, end='\\r')\n",
    "                    break"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "f4bea541-1657-4264-9690-d98b02be7c2e",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "np.random.seed(100)\n",
    "tf.random.set_seed(100)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "309333d7-bdb2-4dbd-917b-5ac793213585",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "investing = Investing(S0=S0, T=1.0, r_=[0, 0.025, 0.05],\n",
    "              mu_=[0.05, 0.1, 0.15],\n",
    "              sigma_=[0.1, 0.2, 0.3], steps=252, amount=1) "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "f442546f-b5da-4081-ab10-69c62132ae4d",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "agent = InvestingAgent('2AC', feature=None, n_features=4,\n",
    "                     env=investing, hu=24, lr=0.001)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "196cd97b-abe1-4944-b63f-7da29f97c11b",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "episodes = 250"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "118377b4-cb91-4b33-b7e7-2851b549d48d",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "%time agent.learn(episodes)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "e5da9d2b-70e0-4178-afc6-13c677766fef",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "agent.epsilon"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "6230a337-c7ab-45f7-8507-3a8cb72dce9b",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "agent.env.portfolios = pd.DataFrame()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "e8d4652b-9e71-4a0a-b38b-26181f53a4c8",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "%time agent.test(100)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "151903f4-d5e7-4f9b-afc9-c737d2809b71",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "n = max(agent.env.portfolios['e']) - 2  # <1>"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "eb84d944-8933-4046-bca6-737f411393f4",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "res = agent.env.portfolios[agent.env.portfolios['e'] == n]\n",
    "res.head()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "bb3926e0-d82a-4624-b49b-f7324905020d",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "p = res.iloc[0][['r', 'mu', 'sigma']]"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "4b78af9a-a0a9-454e-bbdf-ffde5435f1a2",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "t = f\"r={p['r']} | mu={p['mu']} | sigma={p['sigma']}\""
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "a6bb1b0b-aded-4bd0-a787-18aeeca0b83f",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "res[['Xt', 'Yt', 'pv']].plot(\n",
    "    title='PORTFOLIO VALUE | ' + t,\n",
    "    style=['g--', 'b:', 'r-'], lw=1);"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "85ef4f89-1a10-4ecc-af5b-f4750d1559b9",
   "metadata": {},
   "outputs": [],
   "source": [
    "rets = res[['Xt', 'Yt', 'pv']].pct_change().mean() / agent.env.dt  # <1>\n",
    "rets"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "99e927ca-cef3-4e0c-a9be-81a805f69936",
   "metadata": {},
   "outputs": [],
   "source": [
    "stds = res[['Xt', 'Yt', 'pv']].pct_change(\n",
    "    ).std() / math.sqrt(agent.env.dt)  # <2>\n",
    "stds"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "a2dcaf29-b3e2-417d-b723-7509b8e8168e",
   "metadata": {},
   "outputs": [],
   "source": [
    "rets[['Xt', 'pv']] / stds[['Xt', 'pv']]  # <3>"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "fecb6a4d-e6f0-4013-b0ee-390d48ee571a",
   "metadata": {},
   "outputs": [],
   "source": [
    "res['xt'].mean()  # <4>"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "c997138c-f7a8-4072-ba53-076105dd2416",
   "metadata": {},
   "outputs": [],
   "source": [
    "res['xt'].std()  # <5>"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "d53e260c-fdce-42d3-8058-f155cd418f54",
   "metadata": {},
   "outputs": [],
   "source": [
    "res['xt'].plot(title='RISKY ALLOCATION | ' + t,\n",
    "               lw=1.0, c='b')\n",
    "plt.ylim(0.55, 0.7);"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "9237f945-6618-4314-b477-d34bc2389c5c",
   "metadata": {},
   "outputs": [],
   "source": [
    "agent.env.portfolios.groupby('mu')['xt'].describe()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "4ff529ed-da46-4eb4-b97d-f62f6abb4f2b",
   "metadata": {},
   "outputs": [],
   "source": [
    "agent.env.portfolios.groupby('sigma')['xt'].describe()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "b8c12127-857d-4459-af42-388866b0caec",
   "metadata": {},
   "outputs": [],
   "source": [
    "agent.env.portfolios.groupby('mu')['pv_new'].describe()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "58bfed3a-46d3-4fa1-a753-90c8a143ff82",
   "metadata": {},
   "outputs": [],
   "source": [
    "agent.env.portfolios.groupby('sigma')['pv_new'].describe()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "179d5611-ad66-4bc8-96a7-81ef6c7e1443",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "n = max(agent.env.portfolios['e']) - 3  # <1>"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "c57cc688-6511-40af-bd3d-a1cee4dc02b4",
   "metadata": {},
   "outputs": [],
   "source": [
    "res = agent.env.portfolios[agent.env.portfolios['e'] == n]"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "e965dcc4-82a9-4f1c-b19b-59dde5e3048a",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "p = res.iloc[0][['r', 'mu', 'sigma']]"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "370451e0-7b09-4d8b-85c7-13b5e91f38c4",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "t = f\"r={p['r']} | mu={p['mu']} | sigma={p['sigma']}\""
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "b2edc590-2370-4d68-9d9d-f7e28d0e3455",
   "metadata": {},
   "outputs": [],
   "source": [
    "res[['Xt', 'Yt', 'pv', 'xt']].plot(\n",
    "    title='PORTFOLIO VALUE | ' + t,\n",
    "    style=['g--', 'b:', 'r-', 'm-.'], lw=1,\n",
    "    secondary_y='xt'\n",
    ");"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "6d304115-a4dd-4a5b-967e-2f4a3ddb07b6",
   "metadata": {},
   "source": [
    "## Two Assets"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "bc0b66c9-03fd-4ee5-be97-5259ec0985fa",
   "metadata": {},
   "outputs": [],
   "source": [
    "class Investing(Investing):\n",
    "    def __init__(self, asset_one='.SPX', asset_two='.VIX',\n",
    "                 steps=252, amount=1):\n",
    "        self.asset_one = asset_one\n",
    "        self.asset_two = asset_two\n",
    "        self.steps = steps\n",
    "        self.initial_balance = amount\n",
    "        self.portfolio_value = amount\n",
    "        self.portfolio_value_new = amount\n",
    "        self.observation_space = observation_space(4)\n",
    "        self.osn = self.observation_space.shape[0]\n",
    "        self.action_space = action_space(1)\n",
    "        self.retrieved = False\n",
    "        self._generate_data()\n",
    "        self.portfolios = pd.DataFrame()\n",
    "        self.episode = 0\n",
    "        \n",
    "    def _generate_data(self):\n",
    "        if self.retrieved:\n",
    "            pass\n",
    "        else:\n",
    "            url = 'https://certificate.tpq.io/rl4finance.csv'  # <1>\n",
    "            self.raw = pd.read_csv(url, index_col=0,\n",
    "                                   parse_dates=True).dropna()  # <2>\n",
    "            self.retrieved = True\n",
    "        self.data = pd.DataFrame()\n",
    "        self.data['Xt'] = self.raw[self.asset_one]\n",
    "        self.data['Yt'] = self.raw[self.asset_two]\n",
    "        s = random.randint(self.steps, len(self.data))  # <3>\n",
    "        self.data = self.data.iloc[s-self.steps:s]  # <4>\n",
    "        self.data = self.data / self.data.iloc[0]  # <5>"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "fe69c425-e014-4590-bf66-4c9ec0ceba76",
   "metadata": {},
   "outputs": [],
   "source": [
    "class Investing(Investing):        \n",
    "    def _get_state(self):\n",
    "        Xt = self.data['Xt'].iloc[self.bar]\n",
    "        Yt = self.data['Yt'].iloc[self.bar]\n",
    "        self.date = self.data.index[self.bar]  # <1>\n",
    "        return np.array([Xt, Yt, self.xt, self.yt]), {}\n",
    "        \n",
    "    def add_results(self, pl):\n",
    "        df = pd.DataFrame({\n",
    "               'e': self.episode, 'date': self.date,  # <2>\n",
    "               'xt': self.xt, 'yt': self.yt,\n",
    "               'pv': self.portfolio_value,\n",
    "               'pv_new': self.portfolio_value_new, 'p&l[$]': pl, \n",
    "               'p&l[%]': pl / self.portfolio_value_new * 100,\n",
    "               'Xt': self.state[0],  'Yt': self.state[1],\n",
    "               'Xt_new': self.new_state[0],\n",
    "               'Yt_new': self.new_state[1],\n",
    "                      }, index=[0])\n",
    "        self.portfolios = pd.concat((self.portfolios, df),\n",
    "                                    ignore_index=True)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "b4bcbe3c-a50e-4649-a8f1-726ead4f4f1f",
   "metadata": {},
   "outputs": [],
   "source": [
    "class Investing(Investing):\n",
    "    def step(self, action):\n",
    "        self.bar += 1\n",
    "        self.new_state, info = self._get_state()\n",
    "        if self.bar == 1:\n",
    "            self.xt = action\n",
    "            self.yt = (1 - action)\n",
    "            pl = 0.\n",
    "            reward = 0.\n",
    "            self.add_results(pl)\n",
    "        else:\n",
    "            self.portfolio_value_new = (\n",
    "                self.xt * self.portfolio_value *\n",
    "                self.new_state[0] / self.state[0] +\n",
    "                self.yt * self.portfolio_value *\n",
    "                self.new_state[1] / self.state[1])\n",
    "            pl = self.portfolio_value_new - self.portfolio_value\n",
    "            pen = 2 * (self.xt - action) ** 2  # <1>\n",
    "            self.xt = action\n",
    "            self.yt = (1 - action)\n",
    "            self.add_results(pl)\n",
    "            ret = self.portfolios['p&l[%]'].iloc[-1] / 100 * 252  # <2>\n",
    "            vol = self.portfolios['p&l[%]'].rolling(\n",
    "                20, min_periods=1).std().iloc[-1] * math.sqrt(252)  # <3>\n",
    "            sharpe = ret / vol # <4>\n",
    "            reward = sharpe - pen  # <5>\n",
    "            self.portfolio_value = self.portfolio_value_new\n",
    "        if self.bar == len(self.data) - 1:\n",
    "            done = True\n",
    "        else:\n",
    "            done = False\n",
    "        self.state = self.new_state\n",
    "        return self.state, reward, done, False, {}"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "bcac62b5-c184-4a47-a4fc-fe7a1b551b6e",
   "metadata": {},
   "outputs": [],
   "source": [
    "days = 2 * 252"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "5aee535b-ef6d-487e-87c2-ddbe1cfb9322",
   "metadata": {},
   "outputs": [],
   "source": [
    "investing = Investing(asset_one='.SPX',\n",
    "            asset_two='.VIX', steps=days)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "b485de0b-e13a-4037-abc7-6dfc154ad646",
   "metadata": {},
   "outputs": [],
   "source": [
    "investing.data.head()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "f6553101-ad40-47f8-8100-5ab143a96fd3",
   "metadata": {},
   "outputs": [],
   "source": [
    "investing.data.corr()  # <1>"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "299564ea-e440-48d0-943e-e5d60a684c79",
   "metadata": {},
   "outputs": [],
   "source": [
    "investing.data.plot(secondary_y='Yt', style=['b', 'g--'], lw=1);"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "c8473e2f-f8e8-4a47-93e3-faf10c00ee9c",
   "metadata": {},
   "outputs": [],
   "source": [
    "random.seed(100)\n",
    "np.random.seed(100)\n",
    "tf.random.set_seed(100)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "a81d98e2-c171-4960-a1df-73967a3b8d03",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "agent = InvestingAgent('2AC', feature=None, n_features=4,\n",
    "                     env=investing, hu=24, lr=0.0005)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "824d6c19-8142-4e49-89b4-aebd302c3115",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "episodes = 125"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "2435dc88-3e67-4f9a-a9c0-e018b9394475",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "%time agent.learn(episodes)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "2dbd842b-b4f6-4ee6-bcc5-730bdcd246be",
   "metadata": {},
   "outputs": [],
   "source": [
    "agent.epsilon"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "90859de3-ca33-4d78-8f13-fd87f8ed19f9",
   "metadata": {},
   "outputs": [],
   "source": [
    "agent.env.portfolios = pd.DataFrame()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "6ba5cbc7",
   "metadata": {},
   "outputs": [],
   "source": [
    "%time agent.test(20)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "3785aeb2-67a5-4e73-a32b-1d2aeeddee82",
   "metadata": {},
   "outputs": [],
   "source": [
    "agent.env.portfolios['xt'].describe()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "d23876a8-9eae-42c4-896c-8372b03cee01",
   "metadata": {},
   "outputs": [],
   "source": [
    "n = max(agent.env.portfolios['e']) - 1"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "5997ea73-8c7b-4e2c-8ade-5e5d77b554c3",
   "metadata": {},
   "outputs": [],
   "source": [
    "res = agent.env.portfolios[agent.env.portfolios['e'] == n]"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "95b78b84-43fa-4996-be72-cb4b676f9e0a",
   "metadata": {},
   "outputs": [],
   "source": [
    "res['xt'].plot(lw=1, c='b')\n",
    "plt.ylim(res['xt'].min() - 0.1, res['xt'].max() + 0.1);"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "5c5e9de2-e82e-4a54-91b1-2b5e2b111706",
   "metadata": {},
   "outputs": [],
   "source": [
    "res[['Xt', 'Yt', 'pv']].iloc[-1]"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "788e7c6b-5d9f-4891-ab00-02d32e17379d",
   "metadata": {},
   "outputs": [],
   "source": [
    "r = np.log(res[['Xt', 'Yt', 'pv']] /\n",
    "           res[['Xt', 'Yt', 'pv']].shift(1))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "87594fb2-c4c4-41bd-a81f-2b456eecb95e",
   "metadata": {},
   "outputs": [],
   "source": [
    "rets = np.exp(r.mean() * 252) - 1\n",
    "rets"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "c4313a90-1c13-4a6e-9600-1933f2049e64",
   "metadata": {},
   "outputs": [],
   "source": [
    "stds = r.std() * math.sqrt(252)\n",
    "stds"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "ec14b2d5-86cf-4095-96dd-d2b757dd400f",
   "metadata": {},
   "outputs": [],
   "source": [
    "rets / stds"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "55814e23-bdab-4776-be41-134d76619f47",
   "metadata": {},
   "outputs": [],
   "source": [
    "res[['Xt', 'Yt', 'pv']].plot(\n",
    "    title='PORTFOLIO VALUE',\n",
    "    style=['g--', 'b:', 'r-'],\n",
    "    lw=1, grid=True);"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "f5e8b746-3587-4263-974a-2b124f24ea46",
   "metadata": {},
   "outputs": [],
   "source": [
    "values = agent.env.portfolios.groupby('e')[['Xt', 'Yt', 'pv']].last()\n",
    "values.tail()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "88c8233e-c2ae-471f-8045-640ed0a34ee2",
   "metadata": {},
   "outputs": [],
   "source": [
    "((values['pv'] > values['Xt']) & (values['pv'] > values['Yt'])).all()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "20e3eaa7-ac35-44e5-bffc-93662c2d2c55",
   "metadata": {},
   "source": [
    "<img src=\"http://hilpisch.com/tpq_logo.png\" alt=\"The Python Quants\" width=\"35%\" align=\"right\" border=\"0\"><br>\n",
    "\n",
    "<a href=\"http://tpq.io\" target=\"_blank\">http://tpq.io</a> | <a href=\"http://twitter.com/dyjh\" target=\"_blank\">@dyjh</a> | <a href=\"mailto:team@tpq.io\">team@tpq.io</a>"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "name": "python3",
   "display_name": "Python 3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.10.16"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}