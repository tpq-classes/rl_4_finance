{
 "cells": [
  {
   "cell_type": "markdown",
   "id": "475819a4-e148-4616-b1cb-44b659aeb08a",
   "metadata": {},
   "source": [
    "<img src=\"https://hilpisch.com/tpq_logo.png\" alt=\"The Python Quants\" width=\"35%\" align=\"right\" border=\"0\"><br>"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "280cc0c6-2c18-46cd-8af7-3f19b64a6d7e",
   "metadata": {},
   "source": [
    "# Reinforcement Learning for Finance\n",
    "\n",
    "**Chapter 07 &mdash; Dynamic Hedging**\n",
    "\n",
    "&copy; Dr. Yves J. Hilpisch\n",
    "\n",
    "<a href=\"https://tpq.io\" target=\"_blank\">https://tpq.io</a> | <a href=\"https://twitter.com/dyjh\" target=\"_blank\">@dyjh</a> | <a href=\"mailto:team@tpq.io\">team@tpq.io</a>"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "87fbe847-8e06-49ed-9352-53772ed456c2",
   "metadata": {},
   "source": [
    "### Please use the \"Python 3.10, Tensorflow 2.10\" kernel."
   ]
  },
  {
   "cell_type": "markdown",
   "id": "d6be6f8b-e00e-402c-9df1-1d3f16e76c7e",
   "metadata": {},
   "source": [
    "## Delta Hedging"
   ]
  },
  {
   "cell_type": "code",
   "metadata": {},
   "execution_count": null,
   "outputs": [],
   "source": [
    "!git clone https://github.com/tpq-classes/rl_4_finance.git\n",
    "import sys\n",
    "sys.path.append('rl_4_finance')\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "b74284e7-9506-4793-bc99-016775313b22",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "import math\n",
    "import random\n",
    "import numpy as np\n",
    "import pandas as pd\n",
    "from scipy import stats\n",
    "from pylab import plt, mpl"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "e80ce705-6c55-46d9-9199-549d8ea689f8",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "plt.style.use('seaborn-v0_8')\n",
    "mpl.rcParams['font.family'] = 'serif'\n",
    "np.set_printoptions(suppress=True)\n",
    "%config InlineBackend.figure_format = 'svg'"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "5cf2bc18-3029-4a69-baf7-21d1efcd54a4",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "from bsm73 import bsm_call_value"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "92fd8b53-2281-4332-9306-c8416e88d8b1",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "S0 = 100  # <1>\n",
    "K = 100  # <2>\n",
    "T = 1.  # <3>\n",
    "t = 0.  # <4>\n",
    "r = 0.05  # <5>\n",
    "sigma = 0.2  # <6>"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "57fd3991-aeb8-408d-aba8-e704fb68e97b",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "bsm_call_value(S0, K, T, t, r, sigma)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "8aa7775b-3842-414f-b6c3-3e1f7dd4b176",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "random.seed(1000)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "c255e96e-11b2-4e66-a990-372a59b1f418",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "def simulate_gbm(S0, T, r, sigma, steps=100):\n",
    "    gbm = [S0]\n",
    "    dt = T / steps\n",
    "    for t in range(1, steps + 1):\n",
    "        st = gbm[-1] * math.exp((r - sigma ** 2 / 2) * dt\n",
    "                    + sigma * math.sqrt(dt) * random.gauss(0, 1))\n",
    "        gbm.append(st)\n",
    "    return gbm"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "00c6d682-1f6e-4e53-93ff-a8db7b3d6626",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "gbm = simulate_gbm(S0, T, r, sigma)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "08e95452-a460-4cb4-945b-f40a4293d055",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "plt.plot(gbm, lw=1.0, c='b');"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "5a749b90-e603-488a-830a-fa71e4df6891",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "def bsm_delta(St, K, T, t, r, sigma):\n",
    "    d1 = ((math.log(St / K) + (r + 0.5 * sigma ** 2) * (T - t)) /\n",
    "          (sigma * math.sqrt(T - t)))\n",
    "    return stats.norm.cdf(d1, 0, 1)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "b3075a0b-5a3b-4a6e-8602-5c790fd8875c",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "S_ = range(40, 181, 4)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "80f18d97-4f6b-46a7-9b6d-a237b4b8dc11",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "d = [bsm_delta(s, K, T, 0, r, sigma) for s in S_]"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "21e59d07-88de-4a5d-882a-a3626db0135d",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "plt.plot(S_, d, lw=1.0, c='b')\n",
    "plt.xlabel('price')\n",
    "plt.ylabel('delta');"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "ee3aeefe-0fbb-40bc-b71a-a3f8b30a092a",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "dt = T / (len(gbm) - 1)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "bc4bcce9-9d70-4105-b116-4d00622d5947",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "bond = [math.exp(r * i * dt) for i in range(len(gbm))]"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "df109760-a22c-4ef0-8f52-b641c4b60d62",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "def option_replication():\n",
    "    res = pd.DataFrame()\n",
    "    for i in range(len(gbm) - 1):\n",
    "        C = bsm_call_value(gbm[i], K, T, i * dt, r, sigma)\n",
    "        if i == 0:\n",
    "            s = bsm_delta(gbm[i], K, T, i * dt, r, sigma)  # <1>\n",
    "            b = (C - s * gbm[i]) / bond[i]  # <2>\n",
    "        else:\n",
    "            V = s * gbm[i] + b * bond[i]  # <3>\n",
    "            s = bsm_delta(gbm[i], K, T, i * dt, r, sigma)  # <4>\n",
    "            b = (C - s * gbm[i]) / bond[i]  # <5>\n",
    "            df = pd.DataFrame({'St': gbm[i], 'C': C, 'V': V,\n",
    "                               's': s, 'b': b}, index=[0])  # <6>\n",
    "            res = pd.concat((res, df), ignore_index=True)  # <6>\n",
    "    return res"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "2b75706b-0254-4334-9a76-033386d96108",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "res = option_replication()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "f91730af-4da5-4111-a511-26d5a2f14d0e",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "res[['C', 'V']].plot(style=['b', 'r--'], lw=1);"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "e1e661ef-0660-4191-999b-7442072fdf8c",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "(res['V'] - res['C']).mean()  # <1>"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "697c07af-406f-497c-8348-508c7a1d6389",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "((res['V'] - res['C']) ** 2).mean()  # <2>"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "d430c959-eec8-489b-ac68-f2d2b096bcd2",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "(res['V'] - res['C']).hist(bins=35, color='b');"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "36861754-df58-40cf-a690-512291df5731",
   "metadata": {},
   "source": [
    "## Hedging Environment"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "0585829d-c4a2-494f-a5b9-ba3a0c6d5b1c",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "class observation_space:\n",
    "    def __init__(self, n):\n",
    "        self.shape = (n,)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "754cfe0d-8fff-4d2d-b96a-d6c611de6226",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "class action_space:\n",
    "    def __init__(self, n):\n",
    "        self.n = n\n",
    "    def seed(self, seed):\n",
    "        random.seed(seed)\n",
    "    def sample(self):\n",
    "        return random.random()  # <1>"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "622556ea-c7fc-4418-862e-c0403506f175",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "class Hedging:\n",
    "    def __init__(self, S0, K_, T, r_, sigma_, steps):\n",
    "        self.initial_value = S0\n",
    "        self.strike_ = K_  # <1>\n",
    "        self.maturity = T\n",
    "        self.short_rate_ = r_  # <1>\n",
    "        self.volatility_ = sigma_  # <1>\n",
    "        self.steps = steps\n",
    "        self.observation_space = observation_space(5)\n",
    "        self.osn = self.observation_space.shape[0]\n",
    "        self.action_space = action_space(1)\n",
    "        self._simulate_data()\n",
    "        self.portfolios = pd.DataFrame()\n",
    "        self.episode = 0"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "bae8dc41-21a9-46e6-abc4-5b18a83a2839",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "class Hedging(Hedging):\n",
    "    def _simulate_data(self):\n",
    "        s = [self.initial_value]\n",
    "        self.strike = random.choice(self.strike_)  # <1>\n",
    "        self.short_rate = random.choice(self.short_rate_)  # <1>\n",
    "        self.volatility = random.choice(self.volatility_)  # <1>\n",
    "        self.dt = self.maturity / self.steps\n",
    "        for t in range(1, self.steps + 1):\n",
    "            st = s[t - 1] * math.exp(\n",
    "              ((self.short_rate - 1 / 2 * self.volatility ** 2) * self.dt +\n",
    "                self.volatility * math.sqrt(self.dt) * random.gauss(0, 1))\n",
    "            )  # <2>\n",
    "            s.append(st)\n",
    "        self.data = pd.DataFrame(s, columns=['index'])\n",
    "        self.data['bond'] = np.exp(self.short_rate *\n",
    "                            np.arange(len(self.data)) * self.dt)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "303c0a10-95af-42e1-8f97-0c9ecc91d4d7",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "class Hedging(Hedging):\n",
    "    def _get_state(self):\n",
    "        St = self.data['index'].iloc[self.bar]\n",
    "        Bt = self.data['bond'].iloc[self.bar]\n",
    "        ttm = self.maturity - self.bar * self.dt\n",
    "        if ttm > 0:\n",
    "            Ct = bsm_call_value(St, self.strike,\n",
    "                           self.maturity, self.bar * self.dt,\n",
    "                           self.short_rate, self.volatility)\n",
    "        else:\n",
    "            Ct = max(St - self.strike, 0)\n",
    "        return np.array([St, Bt, ttm, Ct, self.stock, self.bond]), {} \n",
    "    def seed(self, seed=None):\n",
    "        if seed is not None:\n",
    "            random.seed(seed)\n",
    "    def reset(self):\n",
    "        self.bar = 0\n",
    "        self.bond = 0\n",
    "        self.stock = 0\n",
    "        self.treward = 0\n",
    "        self.episode += 1\n",
    "        self._simulate_data()\n",
    "        self.state, _ = self._get_state()\n",
    "        return self.state, _"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "4ceb2abe-a786-4fcf-a570-24e7099cfae8",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "class Hedging(Hedging):\n",
    "    def step(self, action):\n",
    "        if self.bar == 0:  # <1>\n",
    "            reward = 0\n",
    "            self.bar += 1\n",
    "            self.stock = float(action)  # <2>\n",
    "            self.bond = ((self.state[3] - self.stock * self.state[0]) /\n",
    "                         self.state[1])  # <3>\n",
    "            self.new_state, _ = self._get_state()\n",
    "        else:\n",
    "            self.bar += 1\n",
    "            self.new_state, _ = self._get_state()\n",
    "            phi_value = (self.stock * self.new_state[0] +\n",
    "                   self.bond * self.new_state[1])  # <4>\n",
    "            pl = phi_value - self.new_state[3]  # <5>\n",
    "            df = pd.DataFrame({'e': self.episode, 's': self.stock,\n",
    "                               'b': self.bond, 'phi': phi_value,\n",
    "                               'C': self.new_state[3], 'p&l[$]': pl,\n",
    "                               'p&l[%]': pl / self.new_state[3] * 100,\n",
    "                               'St': self.new_state[0],\n",
    "                               'Bt': self.new_state[1],\n",
    "                               'K': self.strike, 'r': self.short_rate,\n",
    "                               'sigma': self.volatility}, index=[0])  # <6>\n",
    "            self.portfolios = pd.concat((self.portfolios, df),\n",
    "                                        ignore_index=True)  # <6>\n",
    "            reward = -abs(phi_value - self.new_state[3])  # <7>\n",
    "            self.stock = float(action)  # <2>\n",
    "            self.bond = ((self.new_state[3] -\n",
    "                          self.stock * self.new_state[0]) /\n",
    "                          self.new_state[1])  # <3>\n",
    "        if self.bar == len(self.data) - 1:  # <8>\n",
    "            done = True\n",
    "        else:\n",
    "            done = False\n",
    "        self.state = self.new_state\n",
    "        return self.state, float(reward), done, False, {}"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "35fc17a3-cdac-4fff-960b-b2a5e900bb2e",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "S0 = 100."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "2729df4e-7f42-48f3-b3af-7fb2b6b53545",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "hedging = Hedging(S0=S0,\n",
    "              K_=np.array([0.9, 0.95, 1., 1.05, 1.10]) * S0,\n",
    "              T=1.0, r_=[0, 0.01, 0.05],\n",
    "              sigma_=[0.1, 0.15, 0.2], steps=252) "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "130fa362-6876-4749-88fa-077160c3de51",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "hedging.seed(750)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "80e7a078-5f57-44e3-876c-1709d64e4ce4",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "hedging._simulate_data()\n",
    "(hedging.data / hedging.data.iloc[0]).plot(\n",
    "    lw=1.0, style=['r--', 'b-.']);"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "e3325e79-9775-45e5-9796-cea322034eea",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "hedging.reset()\n",
    "for _ in range(hedging.steps - 1):\n",
    "    hedging.step(hedging.action_space.sample())"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "e2cf19e9-f371-44f6-9a1e-ccbc126f44f7",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "hedging.portfolios.head().round(4)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "3af8aa96-6d43-4234-83ca-0e456a1cf356",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "hedging.portfolios[['C', 'phi']].plot(\n",
    "    style=['r--', 'b-'], lw=1, alpha=0.7);"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "7ad77e9f-54ef-4518-b97b-ef573e777a37",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "hedging.portfolios['p&l[$]'].apply(abs).sum()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "a6a61e91-45c7-435b-a198-82c3b68e5db9",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "hedging.portfolios['p&l[$]'].hist(bins=35, color='b');"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "c7e081c2-36de-4851-8c9b-f056939853e8",
   "metadata": {},
   "outputs": [],
   "source": [
    "import os\n",
    "import warnings\n",
    "warnings.simplefilter('ignore')\n",
    "os.environ['TF_CPP_MIN_LOG_LEVEL'] = '3'"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "81052058-331d-41af-99f6-803514a933fc",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "from dqlagent import *"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "83e1990b-3c0c-41fa-8208-b2a77f90ab51",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "random.seed(100)\n",
    "tf.random.set_seed(100)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "753f5091-d0bb-4f47-b6ce-e16bca9ebdb2",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "opt = keras.optimizers.legacy.Adam"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "1bd8fb5d-39f5-4e83-9118-c78846e545a0",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "class HedgingAgent(DQLAgent):\n",
    "    def _create_model(self, hu, lr):\n",
    "        self.model = Sequential()\n",
    "        self.model.add(Dense(hu, input_dim=self.n_features,\n",
    "                        activation='relu'))\n",
    "        self.model.add(Dense(hu, activation='relu'))\n",
    "        self.model.add(Dense(1, activation='linear'))  # <1>\n",
    "        self.model.compile(loss='mse',\n",
    "                optimizer=opt(learning_rate=lr))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "47f55cb0-9513-4a20-aad6-7cba3fc0be7a",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "from scipy.optimize import minimize"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "6085e91b-cc2e-4c99-8d05-205892fb0272",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "class HedgingAgent(HedgingAgent):\n",
    "    def opt_action(self, state):\n",
    "        bnds = [(0, 1)]  # <1>\n",
    "        def f(state, x):  # <2>\n",
    "            state[0, 4] = x  # <3>\n",
    "            state[0, 5] = ((state[0, 3] -\n",
    "                            x * state[0, 0]) /\n",
    "                            state[0, 1])  # <4>\n",
    "            return self.model.predict(state)[0, 0]  # <5>\n",
    "        action = minimize(lambda x: -f(state, x), 0.5,\n",
    "                          bounds=bnds, method='Powell')['x'][0]  # <6>\n",
    "        return action\n",
    "        \n",
    "    def act(self, state):\n",
    "        if random.random() <= self.epsilon:\n",
    "            return self.env.action_space.sample()\n",
    "        action = self.opt_action(state)  # <7>\n",
    "        return action"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "f14d3677-9499-4c71-973e-3b9008028dcc",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "class HedgingAgent(HedgingAgent):\n",
    "    def replay(self):\n",
    "        batch = random.sample(self.memory, self.batch_size)\n",
    "        for state, action, next_state, reward, done in batch:\n",
    "            if not done:\n",
    "                action = self.opt_action(next_state)  # <1>\n",
    "                next_state[0, 4] = action  # <2>\n",
    "                next_state[0, 5] = ((next_state[0, 3] -\n",
    "                                     action * next_state[0, 0]) /\n",
    "                                     next_state[0, 1])  # <3>\n",
    "                reward += (self.gamma *\n",
    "                    self.model.predict(next_state)[0, 0])  # <4>\n",
    "            reward = np.array([reward])\n",
    "            self.model.fit(state, reward, epochs=1,\n",
    "                           verbose=False)\n",
    "        if self.epsilon > self.epsilon_min:\n",
    "            self.epsilon *= self.epsilon_decay"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "e5c90b10-fa10-41c4-ad62-555ea76b7c63",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "class HedgingAgent(HedgingAgent):\n",
    "    def test(self, episodes, verbose=True):\n",
    "        for e in range(1, episodes + 1):\n",
    "            state, _ = self.env.reset()\n",
    "            state = self._reshape(state)\n",
    "            treward = 0\n",
    "            for _ in range(1, len(self.env.data) + 1):\n",
    "                action = self.opt_action(state)\n",
    "                state, reward, done, trunc, _ = self.env.step(action)\n",
    "                state = self._reshape(state)\n",
    "                treward += reward\n",
    "                if done:\n",
    "                    templ = f'total penalty={treward:4.2f}'\n",
    "                    if verbose:\n",
    "                        print(templ)\n",
    "                    break"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "f4bea541-1657-4264-9690-d98b02be7c2e",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "np.random.seed(100)\n",
    "tf.random.set_seed(100)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "f442546f-b5da-4081-ab10-69c62132ae4d",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "hedgingagent = HedgingAgent('SYM', feature=None, n_features=6,\n",
    "                     env=hedging, hu=24, lr=0.0005)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "196cd97b-abe1-4944-b63f-7da29f97c11b",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "episodes = 250"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "118377b4-cb91-4b33-b7e7-2851b549d48d",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "%time hedgingagent.learn(episodes)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "e5da9d2b-70e0-4178-afc6-13c677766fef",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "hedgingagent.epsilon"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "e8d4652b-9e71-4a0a-b38b-26181f53a4c8",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "%time hedgingagent.test(3)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "151903f4-d5e7-4f9b-afc9-c737d2809b71",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "n = max(hedgingagent.env.portfolios['e'])  # <1>\n",
    "n -= 0  # <1>"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "61319424-d973-47bb-9009-e47824335315",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "hedgingagent.env.portfolios[\n",
    "    hedgingagent.env.portfolios['e'] == n][\n",
    "    ['p&l[$]', 'p&l[%]']].mean()  # <2>"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "8c3ceebb-3277-422d-9b86-96eaac230ba6",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "p = hedgingagent.env.portfolios[\n",
    "    hedgingagent.env.portfolios['e'] == n].iloc[0][\n",
    "    ['K', 'r', 'sigma']]"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "22dd24cd-4334-4aa1-9c40-f4fdcfa452bf",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "title = f\"CALL | K={p['K']:.1f} | r={p['r']} | sigma={p['sigma']}\""
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "90ff0fe0-7707-4b0c-a50b-820909f98fca",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "hedgingagent.env.portfolios[\n",
    "    hedgingagent.env.portfolios['e'] == n][\n",
    "    ['phi', 'C', 'St']].iloc[:100].plot(\n",
    "    secondary_y='St', title=title, style=['r-', 'b--', 'g:'], lw=1);"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "bc30fee1-fee9-4b0c-b67d-c24efc05f817",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "hedgingagent.env.portfolios[\n",
    "    hedgingagent.env.portfolios['e'] == n]['p&l[$]'].hist(\n",
    "        bins=35, color='blue')\n",
    "plt.title(title);"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "20e3eaa7-ac35-44e5-bffc-93662c2d2c55",
   "metadata": {},
   "source": [
    "<img src=\"https://hilpisch.com/tpq_logo.png\" alt=\"The Python Quants\" width=\"35%\" align=\"right\" border=\"0\"><br>\n",
    "\n",
    "<a href=\"https://tpq.io\" target=\"_blank\">https://tpq.io</a> | <a href=\"https://twitter.com/dyjh\" target=\"_blank\">@dyjh</a> | <a href=\"mailto:team@tpq.io\">team@tpq.io</a>"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "name": "python3",
   "display_name": "Python 3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.10.16"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}