{
 "cells": [
  {
   "cell_type": "markdown",
   "id": "475819a4-e148-4616-b1cb-44b659aeb08a",
   "metadata": {},
   "source": [
    "<img src=\"https://hilpisch.com/tpq_logo.png\" alt=\"The Python Quants\" width=\"35%\" align=\"right\" border=\"0\"><br>"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "280cc0c6-2c18-46cd-8af7-3f19b64a6d7e",
   "metadata": {},
   "source": [
    "# Reinforcement Learning for Finance\n",
    "\n",
    "**Chapter 09 &mdash; Optimal Execution**\n",
    "\n",
    "&copy; Dr. Yves J. Hilpisch\n",
    "\n",
    "<a href=\"https://tpq.io\" target=\"_blank\">https://tpq.io</a> | <a href=\"https://twitter.com/dyjh\" target=\"_blank\">@dyjh</a> | <a href=\"mailto:team@tpq.io\">team@tpq.io</a>"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "72bdb334-4ae1-494f-b671-de0839d4c6a0",
   "metadata": {},
   "source": [
    "### Please use the \"Python 3.10, Tensorflow 2.10\" kernel."
   ]
  },
  {
   "cell_type": "markdown",
   "id": "d6be6f8b-e00e-402c-9df1-1d3f16e76c7e",
   "metadata": {},
   "source": [
    "## Model Implementation"
   ]
  },
  {
   "cell_type": "code",
   "metadata": {},
   "execution_count": null,
   "outputs": [],
   "source": [
    "!git clone https://github.com/tpq-classes/rl_4_finance.git\n",
    "import sys\n",
    "sys.path.append('rl_4_finance')\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "b74284e7-9506-4793-bc99-016775313b22",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "import math\n",
    "import random\n",
    "import numpy as np\n",
    "import pandas as pd\n",
    "from pylab import plt, mpl"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "e80ce705-6c55-46d9-9199-549d8ea689f8",
   "metadata": {},
   "outputs": [],
   "source": [
    "plt.style.use('seaborn-v0_8')\n",
    "mpl.rcParams['figure.dpi'] = 300\n",
    "mpl.rcParams['savefig.dpi'] = 300\n",
    "mpl.rcParams['font.family'] = 'serif'\n",
    "np.set_printoptions(suppress=True)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "3133637b-925e-4eda-9359-3277a1f3fb6f",
   "metadata": {},
   "outputs": [],
   "source": [
    "class AlmgrenChriss:\n",
    "    def __init__(self, T, N, S0, sigma, X, eta, gamma, lamb):\n",
    "        self.T = T              \n",
    "        self.N = N           \n",
    "        self.dt = T / N\n",
    "        self.S0 = S0\n",
    "        self.sigma = sigma\n",
    "        self.X = X\n",
    "        self.eta = eta\n",
    "        self.gamma = gamma\n",
    "        self.lamb = lamb"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "9b51f547-92f5-42aa-954b-e94a67ac897b",
   "metadata": {},
   "outputs": [],
   "source": [
    "class AlmgrenChriss(AlmgrenChriss):\n",
    "    def optimal_execution(self):\n",
    "        kappa = np.sqrt(self.lamb * self.sigma ** 2 / self.gamma)\n",
    "        t = np.linspace(0, self.T, self.N + 1)\n",
    "        xt_sum = self.X * np.sinh(kappa * (self.T - t)) / np.sinh(kappa * self.T)\n",
    "        xt = -np.diff(xt_sum, prepend=0)\n",
    "        xt[0] = 0\n",
    "        return t, xt"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "67f3080e-92a3-4718-b902-0d6d48c06d20",
   "metadata": {},
   "outputs": [],
   "source": [
    "T = 10  # <1>\n",
    "N = 10  # <2>\n",
    "S0 = 1  # <3>\n",
    "sigma = 0.15  # <4>\n",
    "X = 1  # <5>\n",
    "eta = 0.1  # <6>\n",
    "gamma = 0.1  # <7>\n",
    "lamb = 3e-1  # <8>"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "4b8be5ed-ac8b-4aab-a369-28f0f9eb7ef8",
   "metadata": {},
   "outputs": [],
   "source": [
    "ac = AlmgrenChriss(T, N, S0, sigma, X, eta, gamma, lamb)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "173b22af-cefc-4127-98dc-81b95aeb69c4",
   "metadata": {},
   "outputs": [],
   "source": [
    "t, xt = ac.optimal_execution()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "f1dbaffa-6d84-49f9-b9ba-83e40cf07a64",
   "metadata": {},
   "outputs": [],
   "source": [
    "t"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "908a0cc6-4a11-430d-8ab6-45bb99dbf2a3",
   "metadata": {},
   "outputs": [],
   "source": [
    "xt.round(2)  # <9>"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "a5982844-6447-4976-a56c-717c076f2380",
   "metadata": {},
   "outputs": [],
   "source": [
    "xt.sum()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "0a30eaa3-2f20-4c17-8d71-b68329211a70",
   "metadata": {},
   "outputs": [],
   "source": [
    "ac.lamb = 1e-4  # <10>"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "da69a936-81d8-4e5a-b499-192aa3cd23f7",
   "metadata": {},
   "outputs": [],
   "source": [
    "t, xt_ = ac.optimal_execution()\n",
    "xt_.round(2)  # <11>"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "b140df2e-6c0a-458e-bb4d-0ac215240c26",
   "metadata": {},
   "outputs": [],
   "source": [
    "plt.plot(t, ac.X - xt.cumsum(), 'r', lw=1,\n",
    "         label='high $\\\\lambda$ (position)')\n",
    "plt.plot(t, xt, 'rs', markersize=4,\n",
    "         label='high $\\\\lambda$ (trade)')\n",
    "plt.plot(t, ac.X- xt_.cumsum(), 'b--', lw=1,\n",
    "         label='low $\\\\lambda$ (position)')\n",
    "plt.plot(t, xt_, 'bo', markersize=4,\n",
    "         label='low $\\\\lambda$ (trade)')\n",
    "plt.legend();"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "8a0634b6-fca1-46e2-812c-60065668497d",
   "metadata": {},
   "outputs": [],
   "source": [
    "from numpy.random import default_rng"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "85a0f490-f9c8-4ef3-9017-5bed94bdd1d8",
   "metadata": {},
   "outputs": [],
   "source": [
    "class AlmgrenChriss(AlmgrenChriss):\n",
    "    def simulate_stock_price(self, xt, seed=None):\n",
    "        rng = default_rng(seed=seed)\n",
    "        S = np.zeros(self.N + 1)  # <1>\n",
    "        S[0] = self.S0  # <1>\n",
    "        P = np.zeros(self.N + 1)  # <2>\n",
    "        P[0] = self.S0  # <2>\n",
    "        for t in range(1, self.N + 1):\n",
    "            dZ = rng.normal(0, np.sqrt(self.dt))\n",
    "            S[t] = S[t - 1] + sigma * dZ  # <1>\n",
    "            P[t] = S[t] - self.eta * xt[:t + 1].sum()  # <2>\n",
    "        return S, P"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "9662e0c0-ff3b-43bc-9554-b93877d6d0e6",
   "metadata": {},
   "outputs": [],
   "source": [
    "ac = AlmgrenChriss(T, N, S0, sigma, X, eta, gamma, lamb)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "ba97c718-178a-4508-99d1-ffad7a06e1b8",
   "metadata": {},
   "outputs": [],
   "source": [
    "t, xt = ac.optimal_execution()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "bab93854-fb27-4f2a-86e1-7ab286971bff",
   "metadata": {},
   "outputs": [],
   "source": [
    "xt.round(2)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "78e2e61f-5928-41c8-9d1d-7feb32300c71",
   "metadata": {},
   "outputs": [],
   "source": [
    "seed = 250"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "cbdc03e4-9e90-4845-8cb7-3ccb9f0f4333",
   "metadata": {},
   "outputs": [],
   "source": [
    "S, P = ac.simulate_stock_price(xt, seed=seed)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "33e01e33-89c1-4031-8cf2-1b0e8e382da0",
   "metadata": {},
   "outputs": [],
   "source": [
    "ac.lamb = 1e-4"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "95b468a9-e7e8-48ca-95c8-a602c853725f",
   "metadata": {},
   "outputs": [],
   "source": [
    "t, xt_ = ac.optimal_execution()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "42982f65-3807-453d-99b5-a4829ae42fd9",
   "metadata": {},
   "outputs": [],
   "source": [
    "xt_.round(2)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "7983594a-5a15-46ff-aa48-a1d70731a17f",
   "metadata": {},
   "outputs": [],
   "source": [
    "S, P_ = ac.simulate_stock_price(xt_, seed=seed)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "5505b452-bb5b-4dee-80a9-0d43f1e7819d",
   "metadata": {},
   "outputs": [],
   "source": [
    "plt.plot(t, S, 'b', lw=1, label='simulated stock price path')\n",
    "plt.plot(t, P, 'r--', lw=1, label='adjusted path (high $\\\\lambda$)');\n",
    "plt.plot(t, P_, 'g:', lw=1, label='adjusted path (low $\\\\lambda$)')\n",
    "plt.legend();"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "a3438712-000e-479a-b29e-e48c91d461e9",
   "metadata": {},
   "outputs": [],
   "source": [
    "class AlmgrenChriss(AlmgrenChriss):\n",
    "    def calculate_costs(self, xt):\n",
    "        temporary_cost = np.sum(self.gamma * (xt / self.dt) ** 2 * self.dt)\n",
    "        permanent_cost = np.sum(self.eta * np.cumsum(xt) * xt)\n",
    "        execution_risk = self.lamb * self.sigma ** 2 * np.sum(\n",
    "            (np.cumsum(xt[::-1])[::-1] / self.dt) ** 2 * self.dt)\n",
    "        TEC = temporary_cost + permanent_cost + execution_risk\n",
    "        return temporary_cost, permanent_cost, execution_risk, TEC"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "6c0c6ce0-c0b1-4389-a3c1-ce0ac79ae790",
   "metadata": {},
   "outputs": [],
   "source": [
    "ac = AlmgrenChriss(T, N, S0, sigma, X, eta, gamma, lamb)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "fe806a28-fb66-4836-958c-be0cd4a4bc54",
   "metadata": {},
   "outputs": [],
   "source": [
    "t, xt = ac.optimal_execution()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "81bb88e7-bb87-46f3-817f-74b0f41d3423",
   "metadata": {},
   "outputs": [],
   "source": [
    "tc, pc, er, TEC = ac.calculate_costs(xt)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "0f34c4af-004b-4d6f-b272-e55dfe9e06b4",
   "metadata": {},
   "outputs": [],
   "source": [
    "print(f'lambda = {ac.lamb}')\n",
    "print(f'temporary cost = {tc:7.4f}')\n",
    "print(f'permanent cost = {pc:7.4f}')\n",
    "print(f'execution risk = {er:7.4f}')\n",
    "print(f'total ex. cost = {TEC:7.4f}')  # <1>"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "9b311ed5-2e49-4cfe-bdfc-57d6178a4b5a",
   "metadata": {},
   "outputs": [],
   "source": [
    "ac.lamb = 1e-4"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "af0ef690-631f-43f8-9cfd-60c9717a2d10",
   "metadata": {},
   "outputs": [],
   "source": [
    "t, xt_ = ac.optimal_execution()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "7111a4df-06ce-4dd9-a82f-9dc07067bcf6",
   "metadata": {},
   "outputs": [],
   "source": [
    "tc, pc, er, TEC = ac.calculate_costs(xt_)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "84a07753-123d-4a72-8dfa-0585f231b57f",
   "metadata": {},
   "outputs": [],
   "source": [
    "print(f'lambda = {ac.lamb}')\n",
    "print(f'temporary cost = {tc:7.4f}')\n",
    "print(f'permanent cost = {pc:7.4f}')\n",
    "print(f'execution risk = {er:7.4f}')\n",
    "print(f'total ex. cost = {TEC:7.4f}')  # <2>"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "10fcf9af-e65d-4c04-830f-1f97bafb676e",
   "metadata": {},
   "source": [
    "## Execution Environment"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "e4b6a3d1-0088-4a7d-9143-aa043d97ad04",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "class observation_space:\n",
    "    def __init__(self, n):\n",
    "        self.shape = (n,)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "0925d659-0679-4ecc-a9d1-6923179c23cb",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "class action_space:\n",
    "    def __init__(self, n):\n",
    "        self.n = n\n",
    "    def seed(self, seed):\n",
    "        random.seed(seed)\n",
    "    def sample(self):\n",
    "        return random.random()  # <1>"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "5f1969da-9cf7-4b6b-af36-d00f05500de5",
   "metadata": {},
   "outputs": [],
   "source": [
    "class Execution:\n",
    "    def __init__(self, T, N, S0, sigma, X, eta, gamma, lamb):\n",
    "        self.T = T              \n",
    "        self.N = N           \n",
    "        self.dt = T / N\n",
    "        self.S0 = S0\n",
    "        self.sigma = sigma\n",
    "        self.X = X\n",
    "        self.eta = eta\n",
    "        self.gamma = gamma\n",
    "        self.lamb = lamb\n",
    "        self.episode = 0\n",
    "        self.observation_space = observation_space(3)\n",
    "        self.osn = self.observation_space.shape[0]\n",
    "        self.action_space = action_space(1)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "f1dd96fc-2952-4aa8-b4df-97ddad46af69",
   "metadata": {},
   "outputs": [],
   "source": [
    "class Execution(Execution):\n",
    "    def _simulate_data(self, seed=None):\n",
    "        self.dt = T / N\n",
    "        if hasattr(self, 'seed_'):\n",
    "            seed = self.seed_\n",
    "        rng = default_rng(seed=seed)\n",
    "        self.S = np.zeros(self.N + 1)\n",
    "        self.S[0] = self.S0\n",
    "        for t in range(1, self.N + 1):\n",
    "            dZ = rng.normal(0, np.sqrt(self.dt))\n",
    "            self.S[t] = self.S[t - 1] + self.sigma * dZ\n",
    "        return self.S"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "730f1f6f-7086-4d26-b9c8-4fcbdf9f5d99",
   "metadata": {},
   "outputs": [],
   "source": [
    "class Execution(Execution):\n",
    "    def _get_state(self):\n",
    "        # St = self.S[self.bar]\n",
    "        # Pt = self.S[self.bar] - self.eta * self.xt.sum()\n",
    "        return np.array([self.X_,\n",
    "                         self.bar / self.N,\n",
    "                         self.x]), {}\n",
    "    def seed(self, seed=None):\n",
    "        self.seed = seed\n",
    "    def reset(self):\n",
    "        self.bar = 0\n",
    "        self.x = 0\n",
    "        self.x_ = 0\n",
    "        self.treward = 0\n",
    "        self.episode += 1\n",
    "        self.X_ = self.X\n",
    "        self.xt = np.zeros(self.N + 1)\n",
    "        self.tec = pd.DataFrame(\n",
    "            {'pc': 0, 'tc': 0, 'er': 0}, index=[0])\n",
    "        self._simulate_data()\n",
    "        self.state, _ = self._get_state()\n",
    "        return self.state, _"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "955eb32b-09aa-4b9a-aa5d-fb828671d573",
   "metadata": {},
   "outputs": [],
   "source": [
    "class Execution(Execution):\n",
    "    def step(self, action):\n",
    "        self.bar += 1\n",
    "        self.xt[self.bar] = action\n",
    "        self.x_ = self.x\n",
    "        self.x = action\n",
    "        self.X_ -= action\n",
    "        pc = np.sum(self.eta * np.cumsum(self.xt) * self.xt)\n",
    "        tc = np.sum(self.gamma * (self.xt / self.dt) ** 2 * self.dt)\n",
    "        er = self.lamb * self.sigma ** 2 * np.sum(\n",
    "            (np.cumsum(self.xt[::-1])[::-1] / self.dt) ** 2 * self.dt)\n",
    "        df = pd.DataFrame({'pc': tc, 'tc': pc, 'er': er}, index=[0])\n",
    "        self.tec = pd.concat((self.tec, df))\n",
    "        tec = self.tec.diff().fillna(0).iloc[-1]\n",
    "        cost = tec.sum()\n",
    "        self.state, _ = self._get_state()\n",
    "        pen = 0\n",
    "        reward = 0\n",
    "        if self.bar < self.N:\n",
    "            if self.X_ < 0.05:\n",
    "                done = False  # if True it might stop early (before N is reached)\n",
    "            else:\n",
    "                #pen = abs(self.x - self.x_)\n",
    "                #reward = self.x\n",
    "                done = False\n",
    "        elif self.bar == self.N:\n",
    "            pen = abs(self.X_)\n",
    "            done = True\n",
    "        return self.state, reward-(cost+pen), done, False, {}"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "427487e7-f078-4d3b-9010-76eeaf3ad4ad",
   "metadata": {},
   "outputs": [],
   "source": [
    "execution = Execution(T, N, S0, sigma, X, eta, gamma, lamb=1e-4)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "b979293c-8ff9-4b93-9806-9207fcc081f8",
   "metadata": {},
   "outputs": [],
   "source": [
    "execution.reset()\n",
    "execution.step(1.0)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "6608d2de-72d1-461a-a5d8-4add06e6da68",
   "metadata": {},
   "outputs": [],
   "source": [
    "execution.reset()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "66f33130-bfad-4624-a220-75c17d39005c",
   "metadata": {},
   "outputs": [],
   "source": [
    "execution.step(0.5)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "aafa3d4b-eec2-42ce-a681-5d8b87ff9ed8",
   "metadata": {},
   "outputs": [],
   "source": [
    "execution.step(0.5)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "3b5b6040-9dab-4836-9d99-2edf98743b3f",
   "metadata": {},
   "outputs": [],
   "source": [
    "execution.reset()\n",
    "for i in range(10):\n",
    "    execution.step(0.1)\n",
    "-execution.tec.diff().sum().sum()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "560ec3c3-f924-4384-92aa-a3300fc013d4",
   "metadata": {},
   "source": [
    "## Random Agent"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "c5e55bc6-da56-43d7-bdbe-63d4c542fdf9",
   "metadata": {},
   "outputs": [],
   "source": [
    "execution = Execution(T, N, S0, sigma, X, eta, gamma, lamb=1e-4)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "9ce931db-af5f-4a97-b7e7-803c0d9c13a3",
   "metadata": {},
   "outputs": [],
   "source": [
    "def gen_rn():\n",
    "    alpha = np.ones(N)\n",
    "    rn = np.random.dirichlet(alpha)\n",
    "    rn = np.insert(rn, 0, 0)\n",
    "    return rn"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "14075e66-6de3-4975-9f07-2765a2273c50",
   "metadata": {},
   "outputs": [],
   "source": [
    "rn = gen_rn()\n",
    "rn"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "23ab1b79-89c4-4cbc-967e-cda09130d5cf",
   "metadata": {},
   "outputs": [],
   "source": [
    "rn.sum()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "26c07e40-e472-4d9e-9613-971c6902447f",
   "metadata": {},
   "outputs": [],
   "source": [
    "for _ in range(5):\n",
    "    execution.reset()\n",
    "    rn = gen_rn()\n",
    "    print(rn.round(3))\n",
    "    for i in range(1, 11):\n",
    "        execution.step(rn[i])\n",
    "    print(execution.tec.diff().sum().sum())\n",
    "    print()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "e74b9378-ca79-4154-95cd-3ce0646bed7e",
   "metadata": {},
   "outputs": [],
   "source": [
    "execution = Execution(T, N, S0, sigma, X, eta, gamma, lamb=lamb)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "6b49f055-8ebd-47d3-b1bc-059e330995c3",
   "metadata": {},
   "outputs": [],
   "source": [
    "for _ in range(5):\n",
    "    execution.reset()\n",
    "    rn = gen_rn()\n",
    "    print(rn.round(3))\n",
    "    for i in range(1, 11):\n",
    "        execution.step(rn[i])\n",
    "    print(execution.tec.iloc[-1].sum())\n",
    "    print()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "61df30d7-43e7-4f0f-8bf5-5ed3e7184f7a",
   "metadata": {},
   "source": [
    "## Execution Agent "
   ]
  },
  {
   "cell_type": "markdown",
   "id": "0caebcd5-f2e8-4c1f-897a-71a02eb67abf",
   "metadata": {},
   "source": [
    "**_THIS IS WORK IN PROGRESS._**"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "73d4b256-edf2-47f3-9de8-29dbc7407b74",
   "metadata": {},
   "outputs": [],
   "source": [
    "import os\n",
    "import warnings\n",
    "warnings.simplefilter('ignore')\n",
    "os.environ['TF_CPP_MIN_LOG_LEVEL'] = '3'"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "9669a393-71d2-43be-905f-2d2489d60799",
   "metadata": {},
   "outputs": [],
   "source": [
    "from dqlagent import *"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "83e1990b-3c0c-41fa-8208-b2a77f90ab51",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "# random.seed(100)\n",
    "# tf.random.set_seed(100)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "753f5091-d0bb-4f47-b6ce-e16bca9ebdb2",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "opt = keras.optimizers.legacy.Adam\n",
    "# opt = keras.optimizers.legacy.RMSprop"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "f59596a7-41b8-4be0-a306-34abf31afd3b",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "class ExecutionAgent(DQLAgent):\n",
    "    def _create_model(self, hu, lr):\n",
    "        self.model = Sequential()\n",
    "        self.model.add(Dense(hu, input_dim=self.n_features,\n",
    "                        activation='relu'))\n",
    "        self.model.add(Dense(hu, activation='relu'))\n",
    "        self.model.add(Dense(1, activation='linear'))\n",
    "        self.model.compile(loss='mse',\n",
    "                optimizer=opt(learning_rate=lr))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "492e76bc-0a34-4792-b91c-8a51181acfbb",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "from scipy.optimize import minimize"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "9126cb97-dec7-4bd3-bdbd-28a98d520615",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "class ExecutionAgent(ExecutionAgent):\n",
    "    def opt_action(self, state):\n",
    "        bnds = [(0, state[0, 0])]\n",
    "        def f(state, x):\n",
    "            s = np.copy(state)\n",
    "            s[0, 2] = x\n",
    "            return self.model.predict(s)[0, 0]\n",
    "        action = minimize(lambda x: -f(state, x),\n",
    "                          state[0, 0] / 2,\n",
    "                          bounds=bnds,\n",
    "                          method='Powell'\n",
    "                         )['x'][0]\n",
    "        return action\n",
    "        \n",
    "    def act(self, state):\n",
    "        if random.random() <= self.epsilon or self.episodes < 250:\n",
    "            return min(self.rn[self.f], state[0, 0])\n",
    "        else: \n",
    "            return self.opt_action(state)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "f14d3677-9499-4c71-973e-3b9008028dcc",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "class ExecutionAgent(ExecutionAgent):\n",
    "    def replay(self):\n",
    "        batch = random.sample(self.memory, self.batch_size)\n",
    "        for state, action, next_state, reward, done in batch:\n",
    "            if not done:\n",
    "                action = self.opt_action(next_state)\n",
    "                ns = np.copy(next_state)\n",
    "                ns[0, 2] = action\n",
    "                reward = (self.gamma *\n",
    "                    self.model.predict(ns)[0, 0])\n",
    "            reward = np.array([reward])\n",
    "            self.model.fit(state, reward, epochs=1,\n",
    "                           verbose=False)\n",
    "        if self.epsilon > self.epsilon_min:\n",
    "            self.epsilon *= self.epsilon_decay"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "ba2d09f7-6dcc-4f5c-87f0-98ff47ef95b2",
   "metadata": {},
   "outputs": [],
   "source": [
    "class ExecutionAgent(ExecutionAgent):\n",
    "    def learn(self, episodes):\n",
    "        for e in range(1, episodes + 1):\n",
    "            self.episodes += 1\n",
    "            state, _ = self.env.reset()\n",
    "            state = self._reshape(state)\n",
    "            treward = 0\n",
    "            alpha = np.ones(self.env.N)\n",
    "            rn = np.random.dirichlet(alpha)\n",
    "            self.rn = np.insert(rn, 0, 0)\n",
    "            for f in range(1, 5000):\n",
    "                self.f = f\n",
    "                action = self.act(state)\n",
    "                next_state, reward, done, trunc, _ = self.env.step(action)\n",
    "                treward += reward\n",
    "                next_state = self._reshape(next_state)\n",
    "                self.memory.append(\n",
    "                    [state, action, next_state, reward, done])\n",
    "                state = next_state \n",
    "                if done:\n",
    "                    self.trewards.append(treward)\n",
    "                    self.max_treward = max(self.max_treward, treward)\n",
    "                    templ = f'episode={self.episodes:4d} | '\n",
    "                    templ += f'treward={treward:7.3f}'\n",
    "                    templ += f' | max={self.max_treward:7.3f}'\n",
    "                    print(templ, end='\\r')\n",
    "                    break\n",
    "            if len(self.memory) > self.batch_size:\n",
    "                self.replay()\n",
    "        print()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "cd9816c9-5c62-4f51-807f-f82556d77589",
   "metadata": {},
   "outputs": [],
   "source": [
    "class ExecutionAgent(ExecutionAgent):\n",
    "    def test(self, episodes, verbose=True):\n",
    "        for e in range(1, episodes + 1):\n",
    "            state, _ = self.env.reset()\n",
    "            state = self._reshape(state)\n",
    "            treward = 0\n",
    "            for _ in range(1, self.env.N + 1):\n",
    "                action = self.opt_action(state)\n",
    "                state, reward, done, trunc, _ = self.env.step(action)\n",
    "                state = self._reshape(state)\n",
    "                treward += reward\n",
    "                if done:\n",
    "                    templ = f'total reward={treward:4.3f}'\n",
    "                    if verbose:\n",
    "                        print(templ)\n",
    "                    break\n",
    "            print(self.env.xt)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "37ff6e01-2046-4e54-837e-f2ec7938eca8",
   "metadata": {},
   "outputs": [],
   "source": [
    "execution = Execution(T, N, S0, sigma, X, eta, gamma, lamb=1e-4)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "f04d3b36-09da-4308-8fb2-8577b7f1ca04",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "executionagent = ExecutionAgent(None, feature=None, n_features=3,\n",
    "                     env=execution, hu=24, lr=0.0001)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "d82d5e24-ea19-4381-a19f-7a395ab9207f",
   "metadata": {},
   "outputs": [],
   "source": [
    "executionagent.gamma = 0.99"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "bf61ef54-2635-4d88-8196-420a679b9fe0",
   "metadata": {},
   "outputs": [],
   "source": [
    "executionagent.epsilon_decay = 0.999"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "f086c6de-6d38-4824-ac61-3a1b80e1e860",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "episodes = 100"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "fbdcd07a-3771-4b5c-a953-1c3f20e6e8be",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "%time executionagent.learn(episodes)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "9c04f884-bc35-4639-b143-b336f2f33450",
   "metadata": {},
   "outputs": [],
   "source": [
    "execution.xt"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "0d483a5b-8cc3-427d-b26a-778e7325315c",
   "metadata": {},
   "outputs": [],
   "source": [
    "execution.xt.sum()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "1dee63a3-5b16-4e46-80bc-fce5733bf920",
   "metadata": {},
   "outputs": [],
   "source": [
    "executionagent.test(1)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "b1196568-2b7c-4010-8396-8c749d5e6e88",
   "metadata": {},
   "outputs": [],
   "source": [
    "execution.xt.sum()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "901361e7-be1d-4baa-a952-9aed5de45dfa",
   "metadata": {},
   "outputs": [],
   "source": [
    "len(executionagent.memory)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "20e3eaa7-ac35-44e5-bffc-93662c2d2c55",
   "metadata": {},
   "source": [
    "<img src=\"https://hilpisch.com/tpq_logo.png\" alt=\"The Python Quants\" width=\"35%\" align=\"right\" border=\"0\"><br>\n",
    "\n",
    "<a href=\"https://tpq.io\" target=\"_blank\">https://tpq.io</a> | <a href=\"https://twitter.com/dyjh\" target=\"_blank\">@dyjh</a> | <a href=\"mailto:team@tpq.io\">team@tpq.io</a>"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "name": "python3",
   "display_name": "Python 3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.10.16"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}